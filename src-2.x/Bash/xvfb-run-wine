#!/bin/bash
# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../xorg-server/xvfb-run.sh
# Copyright (C) 2005 The T2 SDE Project
# Copyright (C) XXXX - 2005 Debian
# Modifications for Wine (C) 2019 Espressif Systems (Shanghai) Co. Ltd.
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---

# $Id$
# from: http://necrotic.deadbeast.net/xsf/XFree86/trunk/debian/local/xvfb-run

# This script starts an instance of Xvfb, the "fake" X server, runs a command
# with that server available, and kills the X server when done.  The return
# value of the command becomes the return value of this script.
#
# If anyone is using this to build a Debian package, make sure the package
# Build-Depends on xvfb, xbase-clients, and xfonts-base.

set -e
SERVERNUM=0
AUTHFILE=/root/.Xauthority
ERRORFILE=/dev/null
STARTWAIT=3
XVFBARGS="-screen 0 1024x768x24"
LISTENTCP="-nolisten tcp"
XAUTHPROTO=.

if [ -z "$*" ]; then
    echo "need a command to run"
    exit 2
fi

# Start Xvfb.
MCOOKIE=$(mcookie)

XAUTHORITY=$AUTHFILE xauth source - << EOF >>"$ERRORFILE" 2>&1
add :$SERVERNUM $XAUTHPROTO $MCOOKIE
EOF
XAUTHORITY=$AUTHFILE Xvfb ":$SERVERNUM" $XVFBARGS $LISTENTCP >>"$ERRORFILE" \
  2>&1 &
XVFBPID=$!
sleep "$STARTWAIT"

# Run wine with the given arguments and save the exit status.
set +e
echo "Running in wine: $@"
DISPLAY=:$SERVERNUM XAUTHORITY=$AUTHFILE wine "$@" 2>&1
RETVAL=$?
echo "Wine finished with exit code $RETVAL"
set -e

# Wait for wine to finish
if [ $RETVAL -eq 0 ]; then
    echo "Waiting for wineserver to terminate"
    while pgrep wineserver > /dev/null; do
        printf .
        sleep 1;
    done
    echo " Done."
fi

# Kill Xvfb now that the command has exited.
kill $XVFBPID

# Clean up.
XAUTHORITY=$AUTHFILE xauth remove ":$SERVERNUM" >"$ERRORFILE" 2>&1
if [ -n "$XVFB_RUN_TMPDIR" ]; then
    if ! rm -r "$XVFB_RUN_TMPDIR"; then
        echo "problem while cleaning up temporary directory"
        exit 5
    fi
fi

# Return the executed command's exit status.
exit $RETVAL
